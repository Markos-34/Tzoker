from PIL import Image, ImageDraw
import random
import cups
import time 

# Function to parse coordinates from the HTML-like format
def parse_coords(coord_string):
    coords = coord_string.split(',')
    coords = [int(coord.strip()) for coord in coords]
    return coords

# Function to draw 'X' at given coordinates
def draw_x(draw, x, y, size):
    half_size = size // 2
    draw.line([(x - half_size, y - half_size), (x + half_size, y + half_size)], fill='black', width=1)
    draw.line([(x - half_size, y + half_size), (x + half_size, y - half_size)], fill='black', width=1)

# Function to create a blank white image
def create_blank_image(width, height):
    return Image.new('RGB', (width, height), 'white')

# Function to add 'X's to the image based on coordinates
def add_xs(image, area_tags, x_size, num_xs):
    draw = ImageDraw.Draw(image)

    # Randomly shuffle the area_tags to ensure random selection each time
    random.shuffle(area_tags)

    # Ensure we don't add more 'X's than available coordinates
    num_xs = min(num_xs, len(area_tags))

    # Select coordinates and draw 'X's
    for i, coord_string in enumerate(area_tags[:num_xs]):
        coords = parse_coords(coord_string)
        x = (coords[0] + coords[2]) // 2
        y = (coords[1] + coords[3]) // 2
        draw_x(draw, x, y, size=x_size)
        print(f"Added 'X' number {i+1} at coordinates ({x}, {y})")

    print(f"Total added {num_xs} 'X's to the image at the specified coordinates.")

    return image

# Function to print the image using CUPS
def print_image(image, width, height):
    conn = cups.Connection()
    printers = conn.getPrinters()

    if not printers:
        print("No printers found. Ensure you have a printer configured and CUPS is running.")
        return

    # Assuming there is at least one printer available
    printer_name = list(printers.keys())[0]  # Adjust this based on your setup

    print_options = {
        'media': 'Custom.20.3x16.9cm',  # Specify the media type (custom size)
        'fit-to-page': 'false',          # Do not fit the image to the page
        'landscape': 'false',            # Portrait orientation
        'PageSize': f'{width}x{height}cm',  # Specify exact paper size in cm
        'InputSlot': 'Automatic'         # Input tray selection (if applicable)
    }

    try:
        # Save the image to a temporary file
        temp_image_path = 'Scan1.jpeg'
        image.save(temp_image_path)

        # Print the temporary image file
        conn.printFile(printer_name, temp_image_path, "Python Image", print_options)
        print(f"Printed modified image to {printer_name}")
    except cups.IPPError as e:
        print(f"Failed to print: {e}")



def main():
    # Coordinates from the HTML-like format for each box
    area_tags_list = [
        #Box 1
        [
            "59,147,77,164", "78,147,97,164", "98,147,116,164", "116,149,133,163", "136,148,153,163",
            "59,165,78,180", "78,165,97,180", "98,165,115,180", "115,164,135,180", "136,165,153,180",
            "59,181,78,197", "79,182,96,195", "98,180,116,197", "117,181,134,197", "135,181,153,197",
            "59,198,78,213", "79,198,97,213", "98,198,116,213", "117,198,135,213", "136,198,153,213",
            "59,214,78,229", "77,214,97,229", "98,214,116,229", "116,214,134,229", "134,214,153,229",
            "59,230,78,245", "79,230,97,245", "98,230,116,245", "117,230,134,245", "135,230,153,245",
            "59,246,78,261", "77,246,97,261", "98,246,116,261", "117,246,134,261", "135,246,153,261",
            "59,262,78,277", "78,261,97,277", "98,261,115,277", "116,262,135,277", "136,262,153,277",
            "59,278,78,293", "79,278,97,293", "98,278,116,293", "116,278,135,293", "136,278,153,293"
        ],
        #Box 2
        [
            "171,148,190,164", "191,148,209,164", "210,148,228,164", "229,148,247,164", "247,148,266,164",
            "171,165,191,180", "190,165,210,180", "211,165,228,180", "228,165,247,180", "248,165,266,180",
            "171,180,191,196", "190,181,210,196", "211,181,228,196", "229,181,247,196", "247,181,266,196",
            "171,197,191,213", "192,197,210,213", "210,197,228,213", "229,197,247,213", "247,197,266,213",
            "171,214,191,229", "191,214,210,229", "209,214,229,229", "230,214,247,229", "247,214,266,229",
            "171,230,191,245", "191,229,209,245", "210,230,229,245", "230,230,247,245", "247,230,266,245",
            "171,246,191,261", "191,246,210,261", "211,246,228,261", "229,246,248,261", "248,246,266,261",
            "171,262,191,277", "191,262,210,277", "210,262,229,277", "229,262,248,277", "171,278,190,293",
            "191,278,209,293", "210,278,228,293", "229,278,248,293", "249,278,266,293", "284,147,303,164"
        ],
        #Box 3
        [
            "304,147,322,164", "323,147,341,164", "341,147,360,164", "360,147,378,164", "284,165,303,180",
            "303,165,322,180", "323,165,340,180", "341,165,359,180", "360,165,378,180", "284,181,303,196",
            "303,181,322,196", "322,181,341,196", "341,181,360,196", "360,181,378,196", "284,197,304,212",
            "304,197,322,212", "322,197,341,212", "341,197,360,212", "360,197,378,212", "284,213,303,228",
            "303,213,322,228", "323,213,341,228", "323,213,341,228", "360,213,378,228", "284,228,303,244",
            "303,229,322,244", "323,228,341,244", "342,229,360,244", "360,229,378,244", "284,245,303,261",
            "304,245,322,261", "323,245,341,261", "341,245,360,261", "361,245,378,261", "284,262,304,277",
            "304,261,322,277", "323,261,341,277", "341,261,360,277", "361,261,378,277", "284,278,304,293",
            "304,278,322,293", "322,278,341,293", "342,278,360,293", "360,278,378,293", "397,147,415,163"
        ],
        #Box 4
        [
            "416,147,435,163", "436,147,454,163", "454,147,472,163", "472,147,491,163", "397,164,416,179",
            "417,164,435,179", "436,164,454,179", "454,164,472,179", "472,164,491,179", "397,179,416,195",
            "416,179,435,195", "436,180,454,195", "454,179,472,195", "472,180,491,195", "397,196,416,212",
            "416,196,435,212", "436,196,453,212", "453,196,472,212", "473,196,491,212", "397,212,416,228",
            "417,212,435,228", "436,213,453,228", "454,213,472,228", "473,213,491,228", "397,229,416,244",
            "416,229,435,244", "435,229,453,244", "453,229,472,244", "472,229,491,244", "397,245,416,260",
            "416,244,435,260", "435,245,453,260", "453,245,472,260", "473,245,491,260", "397,261,416,276",
            "417,261,435,276", "436,261,453,276", "454,261,472,276", "473,261,491,276", "397,277,416,293",
            "417,277,435,293", "436,277,453,293", "454,277,472,293", "472,277,491,293", "473,278,491,293"
        ],
        #Box 5
        [
            "530,147,548,163", "549,147,566,163", "565,147,585,163", "567,147,584,162", "509,164,529,179",
            "529,164,548,179", "548,164,566,179", "566,164,585,179", "567,163,584,178", "585,164,603,179",
            "509,180,529,195", "530,180,548,195", "548,180,566,195", "566,180,585,195", "585,179,603,195",
            "509,196,529,211", "530,196,548,211", "548,196,566,211", "566,196,584,211", "584,195,603,211",
            "509,212,529,227", "530,212,547,227", "548,212,566,227", "567,212,584,227", "585,212,603,227",
            "509,228,529,243", "530,228,547,243", "547,228,566,243", "566,228,584,243", "585,228,603,243",
            "509,244,529,260", "530,244,547,260", "548,244,566,260", "567,244,585,260", "586,244,603,260",
            "509,261,529,276", "530,261,547,276", "548,261,566,276", "567,261,584,276", "584,261,603,276",
            "509,277,529,292", "530,277,547,292", "548,277,566,292", "566,277,584,292", "585,277,603,292"
        ],
        #Box 6
        [
            "623,147,641,163", "641,147,659,163", "659,147,678,163", "679,147,698,163", "699,147,716,163",
            "623,164,641,179", "642,164,659,179", "659,164,679,179", "679,164,698,179", "698,164,716,179",
            "623,180,642,194", "642,180,659,194", "660,180,679,194", "680,180,698,194", "699,180,716,194",
            "623,195,641,211", "642,195,660,211", "661,195,679,211", "679,195,698,211", "699,195,716,211",
            "623,212,641,227", "642,212,660,227", "661,212,679,227", "680,212,698,227", "698,212,716,227",
            "623,228,642,243", "642,228,660,243", "661,228,679,243", "680,228,698,243", "698,228,716,243",
            "623,244,642,259", "643,244,660,259", "661,244,679,259", "679,244,698,259", "698,244,716,259",
            "623,260,642,276", "643,260,660,276", "661,260,679,276", "680,260,698,276", "699,260,716,276",
            "623,277,641,292", "642,277,660,292", "660,277,679,292", "680,277,698,292", "698,277,716,292"
        ],
        #tzoker box 1
        [
            "59,342,77,358", "77,342,96,358", "96,342,116,358", "117,342,134,358", "135,342,152,358",
            "59,359,77,374", "77,359,96,374", "96,359,115,374", "116,359,134,374", "135,359,152,374",
            "59,375,77,390", "77,375,96,390", "97,375,115,390", "116,375,134,390", "135,375,152,390",
            "59,391,77,407", "78,391,97,407", "96,391,116,407", "116,391,134,407", "134,391,152,407"
        ],
        #tzoker box 2
        [
            "171,342,191,358", "191,342,210,358", "210,342,228,358", "227,342,247,358", "247,342,266,358",
            "171,359,191,374", "191,359,210,374", "211,358,228,374", "228,358,247,374", "247,358,266,374",
            "171,375,191,390", "192,374,210,390", "209,375,228,390", "229,375,247,390", "246,374,266,390",
            "171,390,191,406", "192,390,210,406", "210,391,228,406", "228,390,247,406", "248,391,266,406"
        ],
        
        #tzoker box 3
        [
            "284,341,303,358", "304,341,322,358", "323,341,341,358", "341,341,360,358", "360,341,378,358",
            "284,359,303,374", "304,359,322,374", "323,359,341,374", "341,359,360,374", "361,359,378,374",
            "284,375,303,390", "304,375,323,390", "324,375,341,390", "342,375,360,390", "360,375,378,390",
            "284,391,303,407", "304,391,323,407", "323,390,341,407", "341,391,360,407", "360,391,378,407"           
        ],
        #tzoker box 4
        [
            "397,342,416,358", "417,342,435,358", "436,342,455,358", "456,342,473,358", "474,342,491,358",
            "397,359,416,374", "417,359,435,374", "436,358,454,374", "454,359,473,374", "473,359,491,374",
            "397,375,416,391", "417,375,435,391", "435,375,454,391", "454,375,473,391", "472,375,491,391",
            "397,392,416,407", "417,392,435,407", "435,392,454,407", "454,392,472,407", "473,392,491,407"            
        ],
        #tzoker box 5
        [
            "509,342,529,358", "530,342,548,358", "548,342,566,358", "567,342,585,358", "585,342,604,358",
            "509,359,529,374", "529,359,548,374", "549,359,567,374", "567,359,585,374", "585,359,604,374",
            "509,375,529,391", "529,375,548,391", "548,375,567,391", "567,375,585,391", "586,375,604,391",
            "509,392,529,407", "529,392,548,407", "549,392,567,407", "566,392,585,407", "586,392,604,407"            
        ],
        #tzoker box 6
        [
            "622,342,641,357", "642,342,660,357", "661,342,679,357", "680,342,698,357", "698,342,717,357",
            "622,358,642,373", "642,358,660,373", "661,358,679,373", "680,358,698,373", "698,358,717,373",
            "622,374,642,390", "642,374,661,390", "661,374,679,390", "679,374,698,390", "698,374,717,390",
            "622,391,642,406", "643,391,661,406", "662,391,679,406", "678,391,698,406", "699,391,717,406"             
        ]
    ]
    

    
    # Define the size of the blank image (e.g., larger size in pixels at 300 DPI)
    width, height = 3000, 2500  # Larger size in pixels at 300 DPI

    # Create a blank white image
    image = create_blank_image(width, height)

    # Add 'X's to the image for boxes 1 to 6
    x_size = 20  # Size of 'X's to draw
    num_xs_per_box = 5  # Number of 'X's to add per box

    for index, area_tags in enumerate(area_tags_list[:6]):
        print(f"Processing box {index + 1}")
        image = add_xs(image, area_tags, x_size, num_xs_per_box)

    # Add 'X's to the image for tzoker boxes 1 to 6
    num_xs_tzoker = 1  # Number of 'X's to add per tzoker box

    for index, area_tags in enumerate(area_tags_list[6:], start=7):
        print(f"Processing tzoker box {index - 6}")
        image = add_xs(image, area_tags, x_size, num_xs_tzoker)
        
        
    # Save the image to a file
    output_image_path = 'output_image.jpeg'
    image.save(output_image_path)
    print(f"Saved image to {output_image_path}")

    # Print the modified image directly to the printer
    print_image(image, width, height)

# Execute the main function if this script is run directly
if __name__ == "__main__":
    main()
